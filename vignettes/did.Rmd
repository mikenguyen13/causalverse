---
title: "Difference-in-Differences"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{did}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(causalverse)
```

# Assumptions

## Pre-treatment Parallel Trends

### plot_par_trends

The `plot_par_trends` function is designed to assist researchers and analysts in visualizing parallel trends in longitudinal datasets, particularly for datasets with treatment and control groups. This tool makes it easy to visualize changes over time for various outcome metrics between the groups.

#### Data Structure

For optimal use of `plot_par_trends`, ensure your data is structured in the following manner:

-   `entity`: A unique identifier for each observation (e.g., individuals, companies).
-   `time`: The time period for the observation.
-   Treatment status column: Distinguishing treated observations from controls.
-   Metric columns: Capturing the outcome measures of interest.

#### Sample Data Generation

For demonstration purposes, we can generate some illustrative data:

```{r}
library(tidyverse)
data <- expand.grid(entity = 1:100, time = 1:10) %>%
  dplyr::arrange(entity, time) %>%
  dplyr::mutate(
    treatment = ifelse(entity <= 50, "Treated", "Control"),
    outcome1 = 0.5 * time + rnorm(n(), 0, 2) + ifelse(treatment == "Treated", 0, 0),
    outcome2 = 3 + 0.3 * time + rnorm(n(), 0, 1) + ifelse(treatment == "Treated", 0, 2)
  )
```

Visualizing Trends with `plot_par_trends` Invoke the `plot_par_trends` function using the sample data:

```{r}
results <- plot_par_trends(
  data = data,
  metrics_and_names = list(outcome1 = "Outcome 1", outcome2 = "Outcome 2"),
  treatment_status_var = "treatment",
  time_var = list(time = "Time"),
  smoothing_method = "glm",
  # title_prefix = "Para Trends"
)

```

Note: This custom function is built based on the geom_smooth function from ggplot2. Therefore, it supports most of the smoothing methods you'd find in ggplot2, such as `lm`, `glm`, `loess`, etc.

The function returns a list of ggplot objects, which can be visualized using tools like `gridExtra`

```{r}
library(gridExtra)
gridExtra::grid.arrange(grobs = results, ncol = 1)
```

**Note** of Caution: When using this custom package, it's crucial to carefully examine parallel trends plots both with and without control variables. At times, one might observe suitable parallel trends without control variables. However, when these control variables are introduced, the underlying assumptions can be disturbed. Conversely, there are cases where the general parallel trends assumption doesn't seem to be in place, but when conditioned on the control variables, the trends align perfectly. This package provides functions that allow users to easily generate these plots side by side, especially after formulating the predicted values of dependent variables by accounting for control variables. Always approach these plots with a discerning eye to ensure accurate interpretation and application.

In this demonstration, I've incorporated the use of the smoothing function to illustrate its potential application. It's imperative, however, to approach this function with prudence. Although the smoothing function can be invaluable in revealing underlying trends in specific scenarios, its application carries inherent risks. One such risk is the inadvertent or intentional misrepresentation of data, leading observers to falsely deduce the presence of parallel trends where they might not exist. This can potentially skew interpretations and lead to incorrect conclusions.

Given these concerns, if you're inclined to utilize the smoothing function, it's paramount to also consider the implications and insights from our secondary plot. This subsequent visualization offers a more granular and statistically sound perspective, specifically focusing on the pre-treatment disparities between the treated and control groups. It serves as a vital counterbalance, ensuring that any trend interpretations are grounded in robust statistical analysis.
